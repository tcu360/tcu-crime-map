/*!
 * Searchable Map Template with Google Fusion Tables
 * http://derekeder.com/searchable_map_template/
 *
 * Copyright 2012, Derek Eder
 * Licensed under the MIT license.
 * https://github.com/derekeder/FusionTable-Map-Template/wiki/License
 *
 * Date: 12/10/2012
 *
 */// Enable the visual refresh
google.maps.visualRefresh=!0;var MapsLib=MapsLib||{},MapsLib={fusionTableId:"15Blyfz9cTEZqXV77azB_gs17GRoO3cOJgWK_2Hw",googleApiKey:"AIzaSyALDxMa8XW12em3WSqfZhpgRpYEdr8lXTs",locationColumn:"Latitude",map_centroid:new google.maps.LatLng(32.708,-97.363029),locationScope:"fort worth",searchRadius:805,defaultZoom:15,addrMarkerImage:"http://derekeder.com/images/icons/blue-pushpin.png",currentPinpoint:null,markers:[],mappings:{latitude:9,longitude:10,crimeType:0,offenseType:1,dateReported:2},initialize:function(){$("#result_count").html("");geocoder=new google.maps.Geocoder;var e={zoom:MapsLib.defaultZoom,center:MapsLib.map_centroid,mapTypeId:google.maps.MapTypeId.ROADMAP};map=new google.maps.Map($("#map_canvas")[0],e);var t={keepSpiderfied:!0};oms=new OverlappingMarkerSpiderfier(map,t);var n=new google.maps.InfoWindow;oms.addListener("click",function(e,t){n.setContent(e.desc);n.open(map,e)});markerIcons=[];oms.addListener("spiderfy",function(e){for(i in e)e[i].icon.url="img/pin_"+markerIcons[e[i].__gm_id]+".png"});oms.addListener("unspiderfy",function(e){for(i in e)e[i].icon.url="img/pin_"+e.length+".png"});google.maps.event.addDomListener(map,"idle",function(){MapsLib.calculateCenter()});google.maps.event.addDomListener(window,"resize",function(){map.setCenter(MapsLib.map_centroid)});MapsLib.searchrecords=null;$.extend($.tablesorter.themes.bootstrap,{table:"table",icons:"glyphicon",sortNone:"glyphicon-sort",sortAsc:"glyphicon-sort-by-attributes",sortDesc:"glyphicon-sort-by-attributes-alt",active:"active"});$("#search_address").val(MapsLib.convertToPlainString($.address.parameter("address")));var r=MapsLib.convertToPlainString($.address.parameter("radius"));r!=""?$("#search_radius").val(r):$("#search_radius").val(MapsLib.searchRadius);$(":checkbox").attr("checked","checked");$("#result_count").hide();var s=moment("Jan 1 2012"),o=moment(),u=moment().subtract("months",1),a=moment();MapsLib.initializeDateSlider(s,o,u,a,"days",7);MapsLib.doSearch()},doSearch:function(e){MapsLib.clearSearch();var t=$("#search_address").val();MapsLib.searchRadius=$("#search_radius").val();var n=MapsLib.locationColumn+" not equal to ''";n+=" AND 'Date Reported' >= '"+$("#startDate").html()+"'";n+=" AND 'Date Reported' <= '"+$("#endDate").html()+"'";if(t!=""){t.toLowerCase().indexOf(MapsLib.locationScope)==-1&&(t=t+" "+MapsLib.locationScope);geocoder.geocode({address:t},function(e,r){if(r==google.maps.GeocoderStatus.OK){MapsLib.currentPinpoint=e[0].geometry.location;$.address.parameter("address",encodeURIComponent(t));$.address.parameter("radius",encodeURIComponent(MapsLib.searchRadius));map.setCenter(MapsLib.currentPinpoint);map.setZoom(14);MapsLib.addrMarker=new google.maps.Marker({position:MapsLib.currentPinpoint,map:map,icon:MapsLib.addrMarkerImage,animation:google.maps.Animation.DROP,title:t});n+=" AND ST_INTERSECTS("+MapsLib.locationColumn+", CIRCLE(LATLNG"+MapsLib.currentPinpoint.toString()+","+MapsLib.searchRadius+"))";MapsLib.drawSearchRadiusCircle(MapsLib.currentPinpoint);MapsLib.submitSearch(n,map,MapsLib.currentPinpoint)}else alert("We could not find your address: "+r)})}else MapsLib.submitSearch(n,map)},clearSearch:function(){if(MapsLib.searchrecords!=null)for(i in MapsLib.markers)MapsLib.markers[i].setMap(null);oms.clearMarkers();MapsLib.addrMarker!=null&&MapsLib.addrMarker.setMap(null);MapsLib.searchRadiusCircle!=null&&MapsLib.searchRadiusCircle.setMap(null)},findMe:function(){var e;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){e=new google.maps.LatLng(t.coords.latitude,t.coords.longitude);MapsLib.addrFromLatLng(e)},null):alert("Sorry, we could not find your location.")},addrFromLatLng:function(e){geocoder.geocode({latLng:e},function(e,t){if(t==google.maps.GeocoderStatus.OK){if(e[1]){$("#search_address").val(e[1].formatted_address);$(".hint").focus();MapsLib.doSearch()}}else alert("Geocoder failed due to: "+t)})},drawSearchRadiusCircle:function(e){var t={strokeColor:"#4b58a6",strokeOpacity:.3,strokeWeight:1,fillColor:"#4b58a6",fillOpacity:.05,map:map,center:e,clickable:!1,zIndex:-1,radius:parseInt(MapsLib.searchRadius)};MapsLib.searchRadiusCircle=new google.maps.Circle(t)},submitSearch:function(e,t,n){var r="SELECT * FROM "+MapsLib.fusionTableId+" WHERE "+e,i=["https://www.googleapis.com/fusiontables/v1/query"];i.push("?sql="+encodeURIComponent(r));i.push("&key="+MapsLib.googleApiKey);i.push("&callback=?");$.ajax({url:i.join(""),dataType:"jsonp",success:function(e){if(e.rows){MapsLib.handleError(e);MapsLib.searchrecords=e.rows;MapsLib.drawMarkers(MapsLib.searchrecords);MapsLib.displayList(MapsLib.searchrecords);MapsLib.displaySearchCount(MapsLib.searchrecords.length)}else MapsLib.displaySearchCount(0)}})},drawMarkers:function(e){locationCount=[];for(var t=0;t<e.length;t++){var n=e[t][9].toString()+e[t][10].toString();locationCount[n]?locationCount[n]++:locationCount[n]=1}for(var t=0;t<e.length;t++){var r=e[t],i=new google.maps.LatLng(e[t][9],e[t][10]),s=e[t][MapsLib.mappings.crimeType].replace(/\s+/g,"").toLowerCase(),o={size:new google.maps.Size(46,64),scaledSize:new google.maps.Size(35,48),anchor:new google.maps.Point(17,47)},n=e[t][9].toString()+e[t][10].toString();locationCount[n]>1?o.url="img/pin_"+locationCount[n].toString()+".png":o.url="img/pin_"+s+".png";var u=new google.maps.Marker({position:i,desc:e[t][MapsLib.mappings.crimeType],map:map,icon:o});markerIcons[u.__gm_id]=s;MapsLib.markers.push(u);oms.addMarker(u)}},displayList:function(e){var t="",n=$("#results_list");n.hide().empty();if(e==null)n.fadeOut();else for(var r in e){t="          <tr>            <td><strong>"+e[r][0]+"</strong></td>            <td>"+e[r][1]+"</td>            <td>"+e[r][2]+"</td>            <td>"+e[r][3]+"</td>          </tr>";n.append(t)}$("table").tablesorter({theme:"bootstrap",widthFixed:!0,headerTemplate:"{content} {icon}",widgets:["uitheme"],sortList:[[2,1]],widgetOptions:{filter_reset:".reset"}});$("table").trigger("update");n.show();$("table").fadeIn()},handleError:function(e){if(e["error"]!=undefined){var t=e.error.errors;console.log("Error in Fusion Table call!");for(var n in t){console.log(" Domain: "+t[n].domain);console.log(" Reason: "+t[n].reason);console.log(" Message: "+t[n].message)}}},displaySearchCount:function(e){var t=MapsLib.recordNamePlural;e==1&&(t=MapsLib.recordName);$("#result_count").fadeOut(function(){$("#result_count").text(MapsLib.addCommas(e))});$("#result_count").fadeIn()},addCommas:function(e){e+="";x=e.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var t=/(\d+)(\d{3})/;while(t.test(x1))x1=x1.replace(t,"$1,$2");return x1+x2},calculateCenter:function(){center=map.getCenter()},convertToPlainString:function(e){return e==undefined?"":decodeURIComponent(e)},initializeDateSlider:function(e,t,n,r,i,s){var o=MapsLib.sliderInterval(i);$("#minDate").html(e.format("MMM YYYY"));$("#maxDate").html(t.format("MMM YYYY"));$("#startDate").html(n.format("L"));$("#endDate").html(r.format("L"));$("#date-range").slider({range:!0,step:s,values:[Math.floor((n.valueOf()-e.valueOf())/o),Math.floor((t.valueOf()-e.valueOf())/o)],max:Math.floor((t.valueOf()-e.valueOf())/o),slide:function(t,n){$("#startDate").html(e.clone().add(i,n.values[0]).format("L"));$("#endDate").html(e.clone().add(i,n.values[1]).format("L"))},stop:function(e,t){MapsLib.doSearch()}})},sliderInterval:function(e){return e=="years"?31536e6:e=="quarters"?7879679999.999999:e=="months"?30.4*24*3600*1e3:e=="weeks"?6048e5:e=="days"?864e5:e=="hours"?36e5:1}};