/*!
 * Searchable Map Template with Google Fusion Tables
 * http://derekeder.com/searchable_map_template/
 *
 * Copyright 2012, Derek Eder
 * Licensed under the MIT license.
 * https://github.com/derekeder/FusionTable-Map-Template/wiki/License
 *
 * Date: 12/10/2012
 *
 */// Enable the visual refresh
google.maps.visualRefresh=!0;var MapsLib=MapsLib||{},MapsLib={fusionTableId:"1Iim-T38PxgHCXVkB27hUNmh_8G58aZmxBDrBO9A",googleApiKey:"AIzaSyALDxMa8XW12em3WSqfZhpgRpYEdr8lXTs",locationColumn:"Latitude",map_centroid:new google.maps.LatLng(32.708,-97.363029),locationScope:"fort worth",searchRadius:805,defaultZoom:15,addrMarkerImage:"http://derekeder.com/images/icons/blue-pushpin.png",currentPinpoint:null,markers:[],mappings:{latitude:6,longitude:7,type:0,offense:1,dateReported:2,location:3,status:4,comments:5},typeCounts:{drugsandalcohol:0,propertycrime:0,sexualassault:0,assault:0,miscellaneous:0,fireincident:0},startDate:moment().subtract("days",29),endDate:moment(),initialize:function(){$("#result_count").html("");geocoder=new google.maps.Geocoder;var e={zoom:MapsLib.defaultZoom,center:MapsLib.map_centroid,mapTypeId:google.maps.MapTypeId.ROADMAP,streetViewControl:!1};map=new google.maps.Map($("#map_canvas")[0],e);var t={keepSpiderfied:!0};oms=new OverlappingMarkerSpiderfier(map,t);var n=google.maps.MapTypeId;oms.legColors.usual[n.HYBRID],oms.legColors.usual[n.SATELLITE],oms.legColors.usual[n.TERRAIN],oms.legColors.usual[n.ROADMAP],oms.legColors.highlighted[n.SATELLITE],oms.legColors.highlighted[n.HYBRID],oms.legColors.highlighted[n.TERRAIN],oms.legColors.highlighted[n.ROADMAP]="#333";var r=new google.maps.InfoWindow;oms.addListener("click",function(e,t){r.setContent(e.desc);r.open(map,e)});markerIcons=[];oms.addListener("spiderfy",function(e){for(i in e)e[i].icon.url="img/pin_"+markerIcons[e[i].__gm_id]+".png"});oms.addListener("unspiderfy",function(e){for(i in e)e[i].icon.url="img/pin_"+e.length+".png"});google.maps.event.addDomListener(map,"idle",function(){MapsLib.calculateCenter()});google.maps.event.addDomListener(window,"resize",function(){map.setCenter(MapsLib.map_centroid)});MapsLib.searchrecords=null;$.extend($.tablesorter.themes.bootstrap,{table:"table",icons:"icon pull-right",sortNone:"icon-sort",sortAsc:"icon-sort-up",sortDesc:"icon-sort-down",active:"active"});$("#daterange").daterangepicker({ranges:{"Last 7 Days":[moment().subtract("days",6),moment()],"Last 30 Days":[moment().subtract("days",29),moment()],"This Month":[moment().startOf("month"),moment().endOf("month")],"Last Month":[moment().subtract("month",1).startOf("month"),moment().subtract("month",1).endOf("month")],"All Available Dates":[moment("2012-01-01"),moment()]},startDate:MapsLib.startDate,endDate:MapsLib.endDate,minDate:moment("2012-01-01"),maxDate:moment(),format:"l"},function(e,t){MapsLib.startDate=e;MapsLib.endDate=t;MapsLib.doSearch()});$("#daterange").val(MapsLib.startDate.format("l")+" - "+MapsLib.endDate.format("l"));$("#search_address").val(MapsLib.convertToPlainString($.address.parameter("address")));$(":checkbox").attr("checked","checked");$("#result_count").hide();MapsLib.doSearch()},doSearch:function(e,t){MapsLib.clearSearch();var n=$("#search_address").val();$("#empty-msg").hide();t&&(MapsLib.searchRadius=t);var r=MapsLib.locationColumn+" not equal to ''";r+=" AND 'Date Reported' >= '"+MapsLib.startDate.format("L")+"'";r+=" AND 'Date Reported' <= '"+MapsLib.endDate.format("L")+"'";var i="'Type of Crime'",s=[];$("#drugsandalcohol input").is(":checked")&&s.push("Drugs and Alcohol");$("#propertycrime input").is(":checked")&&s.push("Property Crime");$("#sexualassault input").is(":checked")&&s.push("Sexual Assault");$("#assault input").is(":checked")&&s.push("Assault");$("#miscellaneous input").is(":checked")&&s.push("Miscellaneous");$("#fireincident input").is(":checked")&&s.push("Fire Incident");r+=" AND "+i+" IN ('"+s.join("','")+"')";if(n!=""){n.toLowerCase().indexOf(MapsLib.locationScope)==-1&&(n=n+" "+MapsLib.locationScope);geocoder.geocode({address:n},function(e,t){if(t==google.maps.GeocoderStatus.OK){MapsLib.currentPinpoint=e[0].geometry.location;$.address.parameter("address",encodeURIComponent(n));$.address.parameter("radius",encodeURIComponent(MapsLib.searchRadius));map.setCenter(MapsLib.currentPinpoint);map.setZoom(14);MapsLib.addrMarker=new google.maps.Marker({position:MapsLib.currentPinpoint,map:map,icon:MapsLib.addrMarkerImage,animation:google.maps.Animation.DROP,title:n});r+=" AND ST_INTERSECTS("+MapsLib.locationColumn+", CIRCLE(LATLNG"+MapsLib.currentPinpoint.toString()+","+MapsLib.searchRadius+"))";MapsLib.drawSearchRadiusCircle(MapsLib.currentPinpoint);MapsLib.submitSearch(r,map,MapsLib.currentPinpoint)}else alert("We could not find your address: "+t)})}else MapsLib.submitSearch(r,map)},clearSearch:function(){if(MapsLib.searchrecords!=null)for(i in MapsLib.markers)MapsLib.markers[i].setMap(null);for(i in MapsLib.typeCounts)MapsLib.typeCounts[i]=0;oms.clearMarkers();$("#results_list").empty();MapsLib.addrMarker!=null&&MapsLib.addrMarker.setMap(null);MapsLib.searchRadiusCircle!=null&&MapsLib.searchRadiusCircle.setMap(null)},findMe:function(){var e;navigator.geolocation?navigator.geolocation.getCurrentPosition(function(t){e=new google.maps.LatLng(t.coords.latitude,t.coords.longitude);MapsLib.addrFromLatLng(e)},null):alert("Sorry, we could not find your location.")},addrFromLatLng:function(e){geocoder.geocode({latLng:e},function(e,t){if(t==google.maps.GeocoderStatus.OK){if(e[1]){$("#search_address").val(e[1].formatted_address);$(".hint").focus();MapsLib.doSearch()}}else alert("Geocoder failed due to: "+t)})},drawSearchRadiusCircle:function(e){var t={strokeColor:"#4b58a6",strokeOpacity:.3,strokeWeight:1,fillColor:"#4b58a6",fillOpacity:.05,map:map,center:e,clickable:!1,zIndex:-1,radius:parseInt(MapsLib.searchRadius)};MapsLib.searchRadiusCircle=new google.maps.Circle(t)},submitSearch:function(e,t,n){var r="SELECT * FROM "+MapsLib.fusionTableId+" WHERE "+e,i=["https://www.googleapis.com/fusiontables/v1/query"];i.push("?sql="+encodeURIComponent(r));i.push("&key="+MapsLib.googleApiKey);i.push("&callback=?");$.ajax({url:i.join(""),dataType:"jsonp",success:function(e){if(e.rows){MapsLib.handleError(e);MapsLib.searchrecords=e.rows;MapsLib.drawMarkers(MapsLib.searchrecords);MapsLib.displayList(MapsLib.searchrecords);MapsLib.displaySearchCount(MapsLib.searchrecords.length)}else{MapsLib.displaySearchCount(0);$("#results").hide();$("#empty-msg").show()}}})},drawMarkers:function(e){locationCount=[];for(var t=0;t<e.length;t++){var n=e[t][MapsLib.mappings.latitude].toString()+e[t][MapsLib.mappings.longitude].toString();locationCount[n]?locationCount[n]++:locationCount[n]=1}for(var t=0;t<e.length;t++){var r=e[t],i=new google.maps.LatLng(e[t][MapsLib.mappings.latitude],e[t][MapsLib.mappings.longitude]),s=e[t][MapsLib.mappings.type].replace(/\s+/g,"").toLowerCase(),o={size:new google.maps.Size(46,64),scaledSize:new google.maps.Size(35,48),anchor:new google.maps.Point(17,47)},n=e[t][MapsLib.mappings.latitude].toString()+e[t][MapsLib.mappings.longitude].toString();locationCount[n]>1?o.url="img/pin_"+locationCount[n].toString()+".png":o.url="img/pin_"+s+".png";var u="        <strong>"+e[t][MapsLib.mappings.offense]+"</strong><br />        "+e[t][MapsLib.mappings.location]+"<br />        Status: "+e[t][MapsLib.mappings.status]+"<br />        Reported: "+e[t][MapsLib.mappings.dateReported],a=new google.maps.Marker({position:i,desc:u,map:map,icon:o});markerIcons[a.__gm_id]=s;MapsLib.markers.push(a);oms.addMarker(a);MapsLib.typeCounts[s]++}},displayList:function(e){var t="",n=$("#results_list");for(var r in e){t="        <tr>          <td>"+moment(e[r][MapsLib.mappings.dateReported]).format("l")+"</td>          <td class='color-coded "+e[r][MapsLib.mappings.type].replace(/\s+/g,"").toLowerCase()+"'></td>          <td>"+e[r][MapsLib.mappings.offense]+"<br /><small>"+e[r][MapsLib.mappings.comments]+"</small></td>          <td>"+e[r][MapsLib.mappings.location]+"</td>          <td class='hidden-xs'>"+e[r][MapsLib.mappings.status]+"</td>        </tr>";n.append(t)}$("table.sortable").tablesorter({theme:"bootstrap",widthFixed:!0,headerTemplate:"{content} {icon}",widgets:["uitheme"],sortList:[[0,1]],widgetOptions:{filter_reset:".reset"}});$("table").trigger("update");$("#results").css("display")==="none"&&$("#results").fadeIn()},handleError:function(e){if(e["error"]!=undefined){var t=e.error.errors;console.log("Error in Fusion Table call!");for(var n in t){console.log(" Domain: "+t[n].domain);console.log(" Reason: "+t[n].reason);console.log(" Message: "+t[n].message)}}},displaySearchCount:function(e){$(".filter-incident-type .badge").fadeOut(function(){$("#result_count").text(e);for(var t in MapsLib.typeCounts)$("#"+t+" input").is(":checked")?$("#"+t+" .badge").text(MapsLib.typeCounts[t]):$("#"+t+" .badge").text("")}).fadeIn()},addCommas:function(e){e+="";x=e.split(".");x1=x[0];x2=x.length>1?"."+x[1]:"";var t=/(\d+)(\d{3})/;while(t.test(x1))x1=x1.replace(t,"$1,$2");return x1+x2},calculateCenter:function(){center=map.getCenter()},convertToPlainString:function(e){return e==undefined?"":decodeURIComponent(e)}};